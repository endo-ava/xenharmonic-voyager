# 要件定義書：Xenharmonic Voyager

| ドキュメントバージョン | 作成日    | 更新日    | 更新者       |
| :------------------- | :---------- | :---------- | :------------- |
| 1.1.0              | 2025/10/04 | 2025/10/04 | セレーネ（開発用） |

## 1. アプリケーション概要 (What)

本アプリケーションは、12平均律以外の音響宇宙（Xenharmonic）を探求するための、実験的なWebアプリケーションである。ユーザーが指定したN-EDO (N Equal Divisions of the Octave, N平均律) の音律と和音に対し、その響きの「協和度」を音響心理学モデルに基づいてリアルタイムに計算し、可視化する。

感性や慣習に頼るのではなく、倍音の物理的な干渉（ラフネス）という観点から、響きの美しさを定量的に探求するための「観測装置」として機能する。

## 2. 背景と目的

### 2.1 背景 (Background)

開発者が自身のPythonスキル、特に科学技術計算ライブラリ（NumPy）を用いた物理モデルの実装能力を、具体的なポートフォリオとして証明する必要性が生じた。

既存の音楽制作ソフトや理論アプリは、その多くが一般的な12-EDOを前提としており、なぜ特定の和音が心地よく響くのかという物理的な根源まで踏み込んで探求できるツールは少ない。開発者の音楽理論、数学、物理学への知的好奇心が、このニッチな領域への挑戦の動機となった。

### 2.2 目的 (Purpose)

1.  **スキルの証明:** Pythonを用いた科学技術計算および、学術的なモデルをWebアプリケーションとして実装・デプロイする能力を実証する。
2.  **知的探究:** 音楽の協和という現象を物理モデルを通じて解き明かし、12-EDO以外の音響システムの可能性を探求する。
3.  **価値提供:** 音楽家、作曲家、研究者、そして知的好奇心旺盛なすべての人々に対し、新たな音の可能性を発見するためのユニークな実験環境を提供する。

## 3. コアコンセプト / 設計思想

* **「観測装置」としての役割:** 本アプリは楽器や作曲ツールではなく、音響現象を観測・分析するための実験装置である。ユーザーは研究者のように、パラメータを操作し、結果を観察し、洞察を得る。
* **"Xenharmonic"の精神:** 単に音程が細かい(Microtonal)のではなく、我々の知らない響きの法則(Xenharmonic)を探求するという冒険的な思想を重視する。
* **物理モデルへの忠実さ:** 感覚的な評価を排し、ヘルムホルツやセザレスらが提唱した音響心理学モデルに基づいた、客観的で定量的な協和度の算出を核心とする。

## 4. 想定ユーザー (Who)

本アプリケーションは、以下のユーザーをターゲットとして設計する。

* 音楽理論や音響物理学に興味を持つ学生、研究者。
* 新たな響きを求める実験的な作曲家、ミュージシャン。
* プログラミングと数学・物理の融合に興味を持つ技術者。

### 4.1 ユーザーストーリー例

**Story 1: 作曲家の新たな和音探求**
> 19-EDOで新しい和音進行を模索している作曲家は、[0, 8, 11]という組み合わせを試す。協和度スコアが12-EDOの長三和音より高いことを発見し、この響きが楽曲の主要モチーフとして採用可能かを検討する。比較ゲージにより、直感的に12-EDOとの差異を把握できる。

**Story 2: 学生の音響物理学学習**
> 音響物理学の授業で協和度理論を学んだ学生は、本アプリで様々な音律と和音の組み合わせを実験する。Setharesモデルによる定量的なスコアと、理論で学んだ倍音干渉のメカニズムを結びつけることで、抽象的な概念を体感的に理解する。

**Story 3: 音楽理論研究者の仮説検証**
> 特定の音律における協和構造を研究している研究者は、本アプリを用いて複数の和音パターンの協和度を系統的に測定する。ノコギリ波以外の音色モデル（将来実装予定）との比較により、音色が協和度に与える影響についての仮説を検証する。

## 5. 使用技術

本アプリケーション開発に使用する主要な技術スタック、および開発・インフラ環境は以下の通りである。

### 5.1 主要技術スタック

アプリケーションを直接構成するフレームワーク、ライブラリ。

| 技術 | カテゴリ | バージョン | 用途 |
| :--- | :--- | :--- | :--- |
| **Python** | 言語 | 3.13+ | アプリケーション全体の記述言語 |
| **Streamlit** | Webフレームワーク | 最新版 | インタラクティブなUIの構築およびWebサーバー機能 |
| **NumPy** | 数値計算 | 最新版 | 周波数計算、倍音列生成など、高速な配列演算のため |
| **Pydantic** | データ検証 | 最新版 | 堅牢性向上のため、計算ロジックへの入力値を検証 |

### 5.2 開発・インフラ環境

開発効率の向上、コード品質の担保、およびデプロイメントに使用するツール・サービス。

| 技術 | カテゴリ | 用途 |
| :--- | :--- | :--- |
| **uv** | 依存関係・環境管理 | Python依存管理・仮想環境・バージョン管理の統合ツール |
| **Ruff** | Linter / Formatter | 超高速な静的コード解析とコードフォーマットの実行 |
| **pre-commit** | Gitフック管理 | コミット前のLint/Format自動実行によるコード品質の強制 |
| **Pytest** | テストフレームワーク | 計算ロジックの正しさを保証するための単体テスト |
| **Git / GitHub** | バージョン管理 | ソースコードのバージョン管理、保管、およびCI/CDの起点 |
| **Streamlit Community Cloud** | ホスティング | アプリケーションのデプロイおよび公開 |


## 6. 機能要件

本アプリケーションの機能要件を以下に定義する。

### 6.1 機能カテゴリ

要件IDの百の位は、以下の機能カテゴリを示す。

* **100:** 入力・設定機能 (Input/Control)
* **200:** 計算・ロジック機能 (Calculation/Logic)
* **300:** 出力・可視化機能 (Output/Visualization)

### 6.2 機能要件一覧

優先度はMoSCoW分析（Must, Should, Could, Won't）に基づき評価する。

| 要件ID | カテゴリ | 機能概要 | 詳細 | 優先度 |
| :--- | :--- | :--- | :--- | :--- |
| **MVP-101** | 100 | **音律選択機能** | ユーザーは、分析対象とする音律を12-EDOと19-EDOから選択できる。 | **Must** |
| **MVP-102** | 100 | **和音構成音選択機能** | ユーザーは、3和音を構成する3つの音を、選択中のN-EDOの範囲（0 ~ N-1）で指定できる。 | **Must** |
| **MVP-201** | 200 | **協和度計算機能** | 選択された音律と和音に基づき、セザレスの協和度モデルを用いて、和音全体の協和度スコアを算出する。 | **Must** |
| **MVP-202** | 200 | **固定音色モデル** | 協和度計算に使用する倍音列は、ノコギリ波モデル（第k倍音の振幅が1/k）で固定とする。 | **Must** |
| **MVP-301** | 300 | **協和度スコア表示** | 算出された協和度スコアを、画面上に数値として明確に表示する。 | **Must** |
| SH-301 | 300 | **比較ゲージ表示** | 算出された協和度を、基準値（例: 12-EDOの長三和音）と比較した相対的なゲージとして表示する。 | Should |
| CO-101 | 100 | 音律N値の自由入力 | ユーザーが12, 19以外の任意の整数をNとして入力できるようにする。 | Could |
| CO-102 | 100 | 音色モデル選択機能 | 計算に用いる音色モデルを、ノコギリ波以外（矩形波、サイン波など）からも選択できるようにする。 | Could |
| WO-101 | 100 | 設定の保存・読込 | ユーザーが試した設定を保存、または読み込む機能。 | Won't |
| WO-401 | 400 | 音声再生機能 | 構成した和音の音を実際に鳴らす機能。 | Won't |

### 6.3 協和度計算モデル詳細 (MVP-201の補足)

本アプリケーションでは、以下のモデルを採用する:

- **基本モデル:** Sethares (1993) の音響ラフネスモデル
  - 倍音間の周波数差と臨界帯域幅（Critical Bandwidth）の関係から、音響的な「粗さ（Roughness）」を定量化
  - ラフネスが低いほど協和的、高いほど不協和的と評価される
- **倍音減衰:** ノコギリ波モデル（k番目の倍音振幅 = 1/k）
- **考慮倍音数:** 第1~第10倍音まで
  - 計算負荷と知覚的重要性のバランスを考慮した設定
- **ラフネス計算:** 倍音ペアごとの周波数差とクリティカルバンド幅の比較に基づく

**参考文献:**
- Sethares, W. A. (1993). "Local consonance and the relationship between timbre and scale." *Journal of the Acoustical Society of America*, 94(3), 1218-1228.

## 7. 非機能要件

アプリケーションの品質を保証するため、以下の非機能要件を定義する。

| カテゴリ | 要件 | 目標・指標 |
| :--- | :--- | :--- |
| **ユーザビリティ** | **直感的な操作性** | アプリケーションの操作に、音響物理学の専門知識を必要としない。主要な機能が、初見で理解できるシンプルなUIであること。 |
| **性能** | **インタラクティブな応答性** | ユーザーが入力値を変更してから、計算結果が表示されるまでの時間は2秒以内であること。 |
| **保守性** | **関心の分離** | UIを定義するコード (`app.py`) と、協和度計算のコアロジック (`calculator.py`) が明確に分離されていること。 |
| **テスト容易性** | **ロジックのテストカバレッジ** | `calculator.py`のコアな計算ロジックは、Pytestによる単体テストで網羅されていること。 |
| **コード品質** | **静的解析の遵守** | 全てのコードは、RuffによるLint/Formatチェックをパスしていること。pre-commitフックにより、基準を満たさないコードの混入を防止する。 |
| **移植性・展開性** | **Git-basedデプロイ** | GitHubリポジトリへのpushをトリガーとして、Streamlit Community Cloudへ自動でデプロイが実行できる構成であること。 |
