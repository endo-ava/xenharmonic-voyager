# Plotly活用ガイド: インタラクティブなグラフ作成

**作成日**: 2025-10-18
**カテゴリ**: ナレッジ・技術ガイド
**ステータス**: ✅ 完成

---

## 概要

本ドキュメントは、Pythonのインタラクティブグラフ描画ライブラリ `Plotly` の基本的な考え方と、本プロジェクト `Xenharmonic Voyager` における具体的な活用例を解説します。

### なぜPlotlyが選ばれたのか？

このプロジェクトでは、MatplotlibやSeabornのような他のライブラリではなく、Plotlyを採用しています。それは、このアプリが単なる結果表示ツールではなく、ユーザーが音の響きを探求するための「**観測装置**」としての役割を担うためです。

Plotlyは以下の点で特に優れています。

1.  **インタラクティブ性**: グラフの拡大・縮小、マウスホバーによる詳細情報の表示などが標準機能として備わっており、ユーザーが能動的にデータを探索できます。
2.  **Streamlitとの相性**: `st.plotly_chart()` という一行のコードで、Streamlitアプリにシームレスに高品質なグラフを組み込めます。
3.  **美しいビジュアル**: デフォルトでも洗練されたデザインのグラフが描画でき、学術的なレポートにも耐えうる品質です。
4.  **豊富なグラフタイプ**: 折れ線、散布図、ヒートマップなど多様なグラフをサポートしており、将来の機能拡張にも柔軟に対応できます。

---

## Plotlyの基本構造: FigureとTrace

Plotlyのグラフは、大きく分けて2つの要素で構成されます。この「器」と「中身」の関係を理解することが、Plotlyを使いこなす上での最初のステップです。

1.  **Figure (フィギュア)**: グラフ全体を描画する「**キャンバス**」や「**器**」にあたるオブジェクトです。タイトル、軸ラベル、背景色など、グラフ全体の属性を管理します。
2.  **Trace (トレース)**: 実際にデータを可視化する「**描画**」そのものです。折れ線、散布図、棒グラフなど、グラフの種類ごとにトレースを追加していきます。

**一つのFigure（キャンバス）に、複数のTrace（描画）を重ねていく**ことで、リッチなグラフを構築します。

```python
import plotly.graph_objects as go

# 1. Figure (キャンバス) を作成
fig = go.Figure()

# 2. Trace (描画) を追加
# ここでは折れ線グラフ (Scatter) を追加している
fig.add_trace(go.Scatter(x=[1, 2, 3], y=[4, 5, 6], mode='lines'))

# 3. Layout (見た目) を調整
fig.update_layout(title="Example Chart")

# 4. 表示 (Jupyter Notebookなど)
# fig.show()
```

---

## 実装例: ディソナンス曲線グラフ

本プロジェクトの `src/visualization/dissonance_curve.py` は、Plotlyの実践的なテクニックを学ぶ上で最高の教材です。

### 3.1 グラフの構成

ディソナンス曲線グラフは、以下の**4つのトレース**を一つのFigureに重ねることで実現されています。

-   **Trace 1**: ディソナンス曲線本体（灰色の折れ線）
-   **Trace 2**: ピーク位置を示す線（オレンジの破線）
-   **Trace 3**: 自己干渉ペア（青い点々の散布図）
-   **Trace 4**: 相互干渉ペア（赤い点々の散布図）

### 3.2 テクニック1: `go.Scatter`による複数スタイルの描画

`go.Scatter` は非常に柔軟なトレースで、`mode`引数を変えることで折れ線と散布図の両方を描画できます。

-   **折れ線グラフ**: `mode="lines"`
    ```python
    fig.add_trace(
        go.Scatter(..., mode="lines", line={"color": "gray", "width": 2})
    )
    ```
-   **散布図（点グラフ）**: `mode="markers"`
    ```python
    fig.add_trace(
        go.Scatter(..., mode="markers", marker={"color": "blue", "size": 6})
    )
    ```

### 3.3 テクニック2: `hovertemplate`による動的な情報表示

Plotlyの真骨頂であるホバー情報も、`hovertemplate`引数で巧みにカスタマイズされています。これにより、ユーザーは各データポイントの背景にある詳細な情報を一目で確認できます。

```python
# 1. 表示したい情報のリストを動的に作成
mutual_hover_text = [
    f"<b>Mutual-Interference</b><br>"
    f"Freq: {p.freq1:.1f} Hz ↔ {p.freq2:.1f} Hz<br>"
    f"Normalized Δf (x): {p.normalized_freq_diff:.3f}<br>"
    f"Roughness Contribution: {p.roughness_contribution:.6f}"
    for p in mutual_pairs
]

# 2. text引数とhovertemplate引数を指定
fig.add_trace(
    go.Scatter(
        ...,
        text=mutual_hover_text,
        hovertemplate="%{text}<extra></extra>",
    )
)
```
-   `text=...`: 各データポイントに表示したい情報（HTML形式の文字列）のリストを渡します。
-   `hovertemplate="%{text}<extra></extra>"`:
    -   `%{text}`: `text`引数で渡したリストの内容をここに表示する、という指定です。
    -   `<extra></extra>`: ホバー時に右側に表示される余分なトレース名を非表示にし、表示をスッキリさせるためのおまじないです。

### 3.4 テクニック3: `update_layout`によるデザイン調整

グラフ全体のデザイン（タイトル、軸ラベル、凡例、背景色、グリッド線など）は `fig.update_layout()` で一括して行います。これにより、データの描画ロジックとデザインの調整ロジックを分離できます。

### 3.5 Streamlitとの連携

Presenter層で作成された`Figure`オブジェクトは、UI層で `st.plotly_chart` に渡すだけで、Webアプリ上にインタラクティブなグラフとして表示されます。

```python
# ui/dissonance_curve_view.py
import streamlit as st

def render_dissonance_curve_view(view_model):
    # この一行だけで、作成したPlotlyグラフが表示される
    st.plotly_chart(view_model.fig, use_container_width=True)
```
これにより、グラフ作成の複雑なロジックをUIコードから完全に分離できています。

---

## まとめ

-   Plotlyは、**Figure（器）**に**Trace（描画）**を追加していくことで、インタラクティブなグラフを構築します。
-   `go.Scatter`のような柔軟なトレースと、`hovertemplate`や`update_layout`のような強力なカスタマイズ機能が魅力です。
-   本プロジェクトの `dissonance_curve.py` は、これらの機能を効果的に組み合わせた実践的なお手本です。

## 参考資料

-   [Plotly for Python 公式ドキュメント](https://plotly.com/python/)
-   本プロジェクトの実装: `src/visualization/dissonance_curve.py`
