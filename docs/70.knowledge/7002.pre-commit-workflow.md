# 7002: Pre-commit ワークフローとトラブルシューティング

**作成日**: 2025-10-06
**カテゴリ**: 開発環境・ツール
**関連ドキュメント**: `docs/30.quality/3002.git-pr.md`

## 概要

Pre-commitフックの動作原理と、エラーが出た際の対処方法をまとめる。pre-commitは「2段階で動作する」という特性を理解することが重要。

## Pre-commitの2段階動作

### 1. 自動修正フェーズ（1回目の実行）

```bash
$ git commit -m "feat: add new feature"
# または
$ uv run pre-commit run --all-files
```

この段階で以下が実行される：

- **Ruff**: `--fix` オプション付きで自動修正
- **trailing-whitespace**: 末尾の空白を自動削除
- **end-of-file-fixer**: ファイル末尾に改行を自動追加

**重要**: これらのフックが `Failed` と表示されても、実際には**ファイルが自動修正されている**。

```
trim trailing whitespace.................................................Failed
- hook id: trailing-whitespace
- exit code: 1
- files were modified by this hook    ← 👈 ファイルが修正された！

Fixing .claude/commands/test-fix.md
```

### 2. 検証フェーズ（2回目の実行）

自動修正後、もう一度同じコマンドを実行すると、今度はすべて `Passed` になる：

```bash
$ uv run pre-commit run --all-files

ruff (legacy alias)......................................................Passed
ruff format..............................................................Passed
trim trailing whitespace.................................................Passed
fix end of files.........................................................Passed
```

## 推奨ワークフロー

### 方法1: justfileを使用（最も簡単）

```bash
# コミット前に実行（自動的に2回実行してくれる）
just prepare

# その後、git commit
git commit -m "feat: your message"
```

`just prepare` は以下を実行する：
1. Ruffで自動修正
2. Pre-commitフックを実行（1回目）
3. 自動的にもう一度実行（2回目）

### 方法2: 手動で2回実行

```bash
# 1回目: 自動修正
uv run pre-commit run --all-files

# 2回目: 検証
uv run pre-commit run --all-files

# コミット
git commit -m "feat: your message"
```

### 方法3: Git commitに任せる（フック有効時）

```bash
# pre-commitがgit hookとしてインストール済みの場合
git commit -m "feat: your message"

# 自動修正されたら、もう一度コミット
git add .
git commit -m "feat: your message"
```

## よくある誤解とトラブルシューティング

### 🤔 「Failedと出るから自動修正されていないと思った」

→ **誤解**: `Failed` = 修正失敗
→ **実際**: `Failed` = ファイルを修正したので、再度確認してください

メッセージの `files were modified by this hook` が重要。これは成功のサイン。

### 🤔 「何度実行してもFailedになる」

→ **原因**: 自動修正できないエラーがある（稀）
→ **対処**: エラーメッセージを読んで手動修正

例: `check-yaml` が Failed → YAML構文エラーを手動で直す

### 🤔 「コミット時に毎回2回実行するのが面倒」

→ **解決策**:
1. `just prepare` を使う（推奨）
2. エディタの保存時フォーマット機能を有効にする
3. VS Codeなら `settings.json` に以下を追加：

```json
{
  "[python]": {
    "editor.formatOnSave": true,
    "editor.codeActionsOnSave": {
      "source.fixAll": true
    }
  }
}
```

## Justfile コマンド一覧

```bash
just --list              # コマンド一覧を表示
just fix                 # Ruffで自動修正のみ
just pre                 # Pre-commitフックを実行（1回）
just prepare             # すべて自動修正して検証まで完了（推奨）
just lint                # Lintチェックのみ（修正しない）
just format-check        # フォーマットチェックのみ（修正しない）
```

## まとめ

- **Pre-commitは2段階動作する設計**
- `Failed` = 修正失敗ではなく、ファイルを修正したというサイン
- **`just prepare`** を使えば、コミット前の準備がワンコマンドで完了
- 自動修正されたファイルは `git add` で再度ステージングする必要がある

## 参考リンク

- [Pre-commit公式ドキュメント](https://pre-commit.com)
- [Ruff公式ドキュメント](https://docs.astral.sh/ruff/)
- [Just公式ドキュメント](https://just.systems/)
