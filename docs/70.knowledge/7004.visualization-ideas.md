# グラフ可視化アイディア集

**作成日**: 2025-10-12
**カテゴリ**: ナレッジ・アイディア
**ステータス**: 提案・検討中

---

## 概要

Xenharmonic Voyagerにおける、音響物理学的な洞察を視覚化するためのグラフアイディアを記録する。本ドキュメントは、将来の機能拡張の参考資料として機能する。

**採用ライブラリ**: Plotly（インタラクティブ性とStreamlitとの相性を重視）

---

## 目次

1. [ディソナンス曲線グラフ](#1-ディソナンス曲線グラフdissonance-curve)（優先度：最優先）
2. [倍音スペクトラム比較グラフ](#2-倍音スペクトラム比較グラフ)（優先度：最優先）
3. [クリティカルバンド幅の可視化](#3-クリティカルバンド幅の可視化)（優先度：Could）
4. [EDO比較マトリックス（ヒートマップ）](#4-edo比較マトリックスヒートマップ)（優先度：Could）
5. [履歴の時系列グラフ](#5-履歴の時系列グラフインタラクティブ探索)（優先度：推奨）

---

## 1. ディソナンス曲線グラフ（Dissonance Curve）

### 概要

`docs/10.domain/1001.mathematical-foundation.md` の **5.2.1 ディソナンス曲線** で定義される数式を可視化する。

$$
g(x) = e^{-b_1 x} - e^{-b_2 x}
$$

- $x = \frac{\Delta f}{CB(f_{\min})}$: 正規化された周波数差
- $b_1 = 3.5$, $b_2 = 5.75$: 曲線形状パラメータ

### 視覚化イメージ

```
g(x) ↑
     │     ╱‾‾╲
     │    ╱    ╲___
     │___╱          ‾‾‾‾‾‾‾‾‾
     │
     └────────────────────────→ 正規化周波数差 x
      0   0.1  0.24  0.5   1.0
```

### グラフ要素

1. **曲線本体**:
   - X軸: 正規化された周波数差 $x$ (0 ~ 2.0程度)
   - Y軸: ディソナンス値 $g(x)$ (0 ~ 最大値)
   - 滑らかな曲線で描画

2. **ピーク位置の強調**:
   - $x \approx 0.24$ の位置に縦線を表示
   - 「最大ディソナンス位置」とラベル付け

3. **現在の和音の倍音ペアをプロット**:
   - 選択中の和音から生成される全倍音ペアの正規化周波数差を計算
   - 曲線上に**縦線**または**散布点**としてプロット
   - 色分け例:
     - 青: 同一音内の倍音ペア（自己干渉）
     - 赤: 異なる音間の倍音ペア（相互干渉）

4. **インタラクティブ要素** (Plotly):
   - ホバー時に、各点の詳細情報を表示
     - 倍音ペアの周波数 $(f_1, f_2)$
     - 正規化周波数差 $x$
     - ディソナンス値 $g(x)$
     - ラフネス寄与度 $R = a_1 \times a_2 \times g(x)$

### 教育的意義

- **なぜこの和音が協和/不協和なのか**を物理的に説明
- 倍音がピーク近傍に集中 → 不協和
- 倍音がピークから離れている → 協和
- ユーザーは「どの倍音ペアが不協和の原因か」を視覚的に特定可能

### 実装上の注意点

- 正規化周波数差の計算に使用する $CB(f)$ は、低い方の周波数のCBを使用
- 倍音ペアの総数は $\binom{N \times M}{2}$ で膨大になるため、寄与度の大きいペアのみを表示するフィルタリングオプションを検討

---

## 2. 倍音スペクトラム比較グラフ

### 概要

選択した和音を構成する各音の倍音列を、周波数スペクトラムとして可視化する。ノコギリ波の **1/k減衰則** を視覚的に表現。

### 視覚化イメージ

```
振幅 ↑
     │  │ │   │     │
     │  │ │   │     │
     │  │ │   │ │   │
     │  │ │   │ │   │
     └────────────────────→ 周波数 (Hz)
      440  880 1320  1760
```

### グラフ要素

1. **縦棒グラフ（Stem Plot）**:
   - X軸: 周波数（Hz）
     - 対数スケール推奨（`xaxis_type="log"` in Plotly）
     - 範囲: 基音から第10倍音まで（例: 440 Hz ~ 4400 Hz）
   - Y軸: 振幅（0 ~ 1.0、第1倍音を1.0に正規化）

2. **色分け**:
   - 各音の倍音を**異なる色**で表示
   - 例: 音1=青、音2=緑、音3=赤
   - 凡例で各色が対応する基音を表示（例: "音1: 440 Hz (Step 0)"）

3. **倍音の重なりの強調**:
   - 複数の音の倍音が近接している場合、背景に色付き帯を表示
   - 例: 完全5度（3:2比）では、音1の第3倍音と音2の第2倍音が一致
   - ツールチップで「協和の源泉」であることを説明

4. **インタラクティブ要素**:
   - ホバー時に各倍音の詳細情報を表示
     - 倍音次数 $k$
     - 周波数 $f_k = k \times f_0$
     - 振幅 $a_k = 1/k$
   - ズーム・パン機能で詳細を観察

### 教育的意義

- **なぜ完全5度が協和するのか**を一目で理解
  - 倍音が整数比で重なる → 干渉が少ない
- 音色（倍音構造）が協和度に与える影響を視覚化
- 将来的な音色モデル拡張（矩形波、三角波など）時の比較に活用

### 実装上の注意点

- 対数スケールにより、低音域から高音域まで視認性を確保
- 倍音が完全に一致する場合（ユニゾン、オクターブ）は、棒を重ねずにオフセット表示

---

## 3. クリティカルバンド幅の可視化

### 概要

`docs/10.domain/1001.mathematical-foundation.md` の **4.3 Plomp & Levelt の簡易近似** で定義される線形近似式を可視化。

$$
CB(f) \approx 0.24 \times f + 25 \text{ Hz}
$$

### 視覚化イメージ

```
CB(Hz) ↑
       │         ╱
       │       ╱
       │     ╱
       │   ╱
       └──────────────→ 周波数 (Hz)
        100  1000  5000
```

### グラフ要素

1. **線形グラフ**:
   - X軸: 周波数 (Hz)、対数スケール推奨
   - Y軸: クリティカルバンド幅 (Hz)
   - 範囲: 可聴域全体（20 Hz ~ 20,000 Hz）

2. **現在の和音の基音位置**:
   - 選択中の和音の各音の基音を**マーカー**で表示
   - 各マーカーの位置で、対応するCB値を読み取り可能

3. **CB範囲の色付き帯** (オプション):
   - 各基音に対し、$[f - CB(f)/2, f + CB(f)/2]$ の範囲を色付き帯で表示
   - 帯が重なる領域 → 干渉が発生しやすい

### 教育的意義

- 周波数によって「協和の基準」が変わることを示す
- 低音域では同じ半音差でも不協和になりにくい
- 高音域では細かい音程差でも知覚されやすい

---

## 4. EDO比較マトリックス（ヒートマップ）

### 概要

複数のEDO × 音程の組み合わせでラフネスを計算し、2Dヒートマップとして可視化。異なる音律の「協和構造」の違いを俯瞰する。

### 視覚化イメージ

```
EDO  │ 2度  3度  4度  5度  6度  7度
─────┼───────────────────────────
12   │ 🔴  🟡  🟢  🟢  🟡  🟢
19   │ 🔴  🟢  🟡  🟢  🟡  🟢
31   │ 🔴  🟢  🟢  🟢  🟢  🟢
```

### グラフ要素

1. **ヒートマップ**:
   - X軸: 音程（ステップ数、例: 0~11 for 12-EDO）
   - Y軸: EDO値（例: 12, 19, 22, 31, 41, 53）
   - セルの色: ラフネス値
     - カラーマップ: 青（低ラフネス=協和）→ 赤（高ラフネス=不協和）
     - 推奨: Plotlyの `Viridis` または `RdYlBu_r`

2. **対角線の強調**:
   - オクターブ（ステップ = EDO）の位置を強調
   - すべてのEDOでオクターブは協和的（青）

3. **インタラクティブ要素**:
   - セルをクリック → 対応する和音（ユニゾン+音程）を自動選択
   - ホバー時にラフネス値とセント値を表示

### 教育的意義

- 19-EDOが長3度（6ステップ）で協和的
- 31-EDOが純正音程に強い
- 各EDOの「得意な音程」を発見

### 実装上の注意点

- 計算量が多い（EDO数 × ステップ数）ため、事前計算またはキャッシュが必要
- MVPでは "Could" 優先度、将来の拡張機能として検討

---

## 5. 履歴の時系列グラフ（インタラクティブ探索）

### 概要

観測履歴のラフネス値を時系列でプロットし、試行錯誤の過程を可視化する。

### 視覚化イメージ

```
R ↑
  │    ●        ●
  │         ●
  │ ●            ●
  └──────────────────→ 観測順
   1   2   3   4   5
```

### グラフ要素

1. **散布図 + 折れ線グラフ**:
   - X軸: 観測番号（時系列）
   - Y軸: ラフネス値
   - 点: 各観測
   - 線: 観測順序を示す補助線（オプション）

2. **ピン留め観測の強調**:
   - ピン留めされた観測を**星マーク**で表示
   - 色を変えて強調（例: 金色）

3. **インタラクティブ要素**:
   - 点をクリック → その観測の詳細を表示
     - EDO値
     - 選択された音のステップ
     - ラフネス値
   - （高度）クリックした観測を現在の選択として復元

4. **基準線**:
   - 参照スコア（12-EDOの長三和音）を水平破線で表示
   - ユーザーが基準を超えた協和的な和音を発見したかを視覚化

### 教育的意義

- 探索プロセスの「軌跡」を振り返る
- 「最も協和的な組み合わせ」を発見するプロセスを可視化
- 実験的なアプローチの価値を体験

---

## 実装優先度と技術選定

### 優先度マトリックス

| グラフ | 実装難易度 | 教育的価値 | 実用性 | 総合評価 | 優先度 | MVP対象 |
|:------|:--------:|:--------:|:-----:|:-------:|:------:|:------:|
| **1. ディソナンス曲線** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | **最優先** | ✅ Yes |
| **2. 倍音スペクトラム** | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | **最優先** | ✅ Yes |
| **5. 履歴時系列** | ⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | **推奨** | 🔶 Should |
| **3. CB可視化** | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | Could | ❌ No |
| **4. EDOマトリックス** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | Could | ❌ No |

### MVP実装推奨

**Phase 1（最優先）**: グラフ1 + グラフ2
- 最も教育的価値が高い
- 「なぜ協和するのか」を物理的に説明
- Xenharmonic Voyagerの「観測装置」としての価値を最大化

**Phase 2（推奨）**: グラフ5
- 既存の履歴機能と親和性が高い
- 実装が軽量
- ユーザーの探索体験を向上

**Phase 3（将来）**: グラフ3, 4
- より高度な教育コンテンツ
- 研究者向け機能

---

## 技術選定：Plotly

### 採用理由

1. **インタラクティブ性**:
   - ズーム、パン、ホバー、クリックなど豊富なインタラクション
   - 「観測装置」というコンセプトに最適

2. **Streamlitとの相性**:
   - `st.plotly_chart()` でシームレスに統合
   - レスポンシブ対応

3. **美しいビジュアル**:
   - デフォルトで洗練されたデザイン
   - カスタマイズ性が高い

4. **豊富なグラフタイプ**:
   - 散布図、折れ線、ヒートマップ、3Dプロットなど網羅

### インストール

```bash
uv add plotly
```

### 基本的な使用例

```python
import plotly.graph_objects as go
import streamlit as st

# グラフの作成
fig = go.Figure()
fig.add_trace(go.Scatter(x=[1, 2, 3], y=[4, 5, 6], mode='lines+markers'))
fig.update_layout(title="Example Plot", xaxis_title="X", yaxis_title="Y")

# Streamlitで表示
st.plotly_chart(fig, use_container_width=True)
```

---

## 参考資料

- **Plotly公式ドキュメント**: https://plotly.com/python/
- **Streamlit Plotly統合**: https://docs.streamlit.io/library/api-reference/charts/st.plotly_chart
- **ドメイン設計書**: `docs/10.domain/1001.mathematical-foundation.md`

---

## 更新履歴

| 日付 | 変更内容 | 更新者 |
|:-----|:--------|:------|
| 2025-10-12 | 初版作成、5つのグラフアイディアを記録 | Claude Code |

---

*このドキュメントは、Xenharmonic Voyagerの可視化機能拡張のアイディアベースです。実装時には、ユーザーフィードバックと技術的制約を考慮して優先順位を調整してください。*
