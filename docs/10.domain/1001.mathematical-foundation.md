# 1001. 協和度計算の数学的基盤

**ドキュメント番号**: 1001
**カテゴリ**: ドメイン設計
**最終更新**: 2025-01-05
**関連ドキュメント**: [1004.architecture-implementation.md](./1004.architecture-implementation.md)

---

## 目次

1. [概要](#1-概要)
2. [N-EDO音律理論](#2-n-edo音律理論)
3. [倍音列生成モデル（ノコギリ波）](#3-倍音列生成モデルノコギリ波)
4. [クリティカルバンド幅理論](#4-クリティカルバンド幅理論)
5. [Setharesラフネスモデル](#5-setharesラフネスモデル)
6. [数値例と検証](#6-数値例と検証)
7. [参考文献](#7-参考文献)

---

## 1. 概要

本ドキュメントでは、Xenharmonic Voyagerの協和度計算エンジンの数学的基盤を詳述する。本エンジンは、**Sethares (1993)** の音響ラフネスモデルを実装し、N-EDO（N-Equal Divisions of the Octave, N平均律）における和音の協和度を定量的に計算する。

### 1.1 基本原理

協和度（Consonance）の定量化は、以下の4つの数学的要素の組み合わせによって実現される：

1. **N-EDO音律**: 任意のN平均律における周波数計算
2. **倍音列生成**: 音色モデルに基づく倍音スペクトラムの生成
3. **クリティカルバンド幅**: 聴覚系の周波数分解能の数学的モデル化
4. **ラフネス計算**: 倍音間の物理的干渉による感覚的不協和の計算

### 1.2 計算フロー

```
入力: 和音 (N-EDO steps)
  ↓
周波数変換 (N-EDO formula)
  ↓
倍音列生成 (Timbre model)
  ↓
ペアワイズラフネス計算 (Sethares model)
  ↓
総ラフネス = Σ(all pairs)
  ↓
出力: 協和度スコア (低ラフネス = 高協和)
```

---

## 2. N-EDO音律理論

### 2.1 定義と数学的基礎

**N-EDO (N-Equal Divisions of the Octave)** は、オクターブ（周波数比 2:1）をN個の等しい音程に分割する音律システムである。

#### 2.1.1 周波数計算式

N-EDOにおける第 $n$ ステップの周波数は、基準周波数 $f_{\text{base}}$ から以下の式で計算される：

$$
f(n) = f_{\text{base}} \times 2^{n/N}
$$

**パラメータ:**
- $f_{\text{base}}$: 基準周波数（デフォルト: 440 Hz = A4）
- $N$: オクターブの分割数（12-EDO, 19-EDO, etc.）
- $n$: ステップインデックス（$0 \leq n < N$ でオクターブ内、$n$ は任意の整数でも可）

**導出:**

オクターブを $N$ 等分するということは、連続する2音の周波数比が常に一定である等比数列を考えることに相当する。オクターブ上（$n = N$）で周波数が2倍になる条件から：

$$
f(N) = f_{\text{base}} \times r^N = 2 \times f_{\text{base}}
$$

$$
\therefore r = 2^{1/N}
$$

したがって：

$$
f(n) = f_{\text{base}} \times (2^{1/N})^n = f_{\text{base}} \times 2^{n/N}
$$

#### 2.1.2 セント (Cents) 表現

音程をより直感的に扱うため、**セント (cents)** という対数的単位を用いる。1オクターブ = 1200セントと定義される。

N-EDOにおける1ステップの音程（セント）：

$$
\text{cents per step} = \frac{1200}{N}
$$

一般に、2つの周波数 $f_1$, $f_2$ の音程（セント）は：

$$
\text{interval (cents)} = 1200 \times \log_2\left(\frac{f_2}{f_1}\right)
$$

### 2.2 主要なEDOシステムの例

#### 2.2.1 12-EDO（標準西洋音律）

最も一般的な音律。1ステップ = 100セント = 半音 (semitone)。

**主要な音程（A4 = 440 Hz基準）:**

| ステップ | 音名 | 周波数 (Hz) | 音程名 | セント |
|---------|------|-------------|--------|--------|
| 0 | A4 | 440.00 | ユニゾン | 0 |
| 4 | C♯5 | 554.37 | 長3度 | 400 |
| 7 | E5 | 659.25 | 完全5度 | 700 |
| 12 | A5 | 880.00 | オクターブ | 1200 |

**計算例（完全5度）:**

$$
f(7) = 440 \times 2^{7/12} = 440 \times 1.4983 \approx 659.25 \text{ Hz}
$$

#### 2.2.2 19-EDO（より純正な長3度）

19-EDOは、純正長3度（5:4 ≈ 386セント）により近い近似を提供する。1ステップ ≈ 63.16セント。

**長3度の比較:**

- 純正長3度: $\log_2(5/4) \times 1200 \approx 386.31$ セント
- 12-EDOの長3度（4ステップ）: 400セント（誤差 +13.69セント）
- 19-EDOの長3度（6ステップ）: $6 \times (1200/19) \approx 378.95$ セント（誤差 -7.36セント）

19-EDOは12-EDOよりも純正音程に近い近似を提供し、異なる調律美学を探求できる。

### 2.3 実装における注意点

#### 2.3.1 浮動小数点精度

周波数計算では `float64` (倍精度浮動小数点数) を使用し、十分な精度を確保する。

#### 2.3.2 ステップ範囲の検証

入力検証レイヤー（Pydantic）で、ステップ値が有効範囲内であることを保証する。UI層では `0 ≤ n < N` の範囲に制限されるが、ドメイン層では負のステップ（下のオクターブ）や $N$ 以上のステップ（上のオクターブ）も数学的に有効。

---

## 3. 倍音列生成モデル（ノコギリ波）

### 3.1 倍音列の物理的意義

実際の楽器音は、基音（第1倍音）だけでなく、その整数倍の周波数を持つ**倍音（harmonics/overtones）**を含む。倍音の構成比率が音色（timbre）を決定する。

本実装では、**ノコギリ波（sawtooth wave）**の倍音構造を音色モデルとして採用している。

### 3.2 ノコギリ波の数学的定義

#### 3.2.1 時間領域表現

周期 $T$ のノコギリ波 $x(t)$ は：

$$
x(t) = \frac{2A}{\pi} \left( \frac{\pi t}{T} - \pi \right), \quad 0 \leq t < T
$$

（$A$ は振幅）

#### 3.2.2 フーリエ級数展開

ノコギリ波のフーリエ級数は：

$$
x(t) = \sum_{k=1}^{\infty} \frac{A}{k} \sin(2\pi k f_0 t)
$$

ここで $f_0 = 1/T$ は基本周波数。

**重要な性質:**
- 第 $k$ 倍音の周波数: $f_k = k \times f_0$
- 第 $k$ 倍音の振幅: $a_k = \frac{A}{k}$

つまり、倍音の振幅は倍音次数 $k$ に反比例して減衰する（**1/k減衰則**）。

### 3.3 実装モデル

#### 3.3.1 離散倍音モデル

無限級数は計算不可能なため、有限個の倍音で打ち切る。本実装では **デフォルト10倍音** を使用。

基本周波数 $f_0$ に対する倍音列：

$$
\begin{aligned}
\text{Harmonic}_k &= (f_k, a_k) \\
f_k &= k \times f_0, \quad k = 1, 2, 3, \ldots, 10 \\
a_k &= \frac{1}{k}
\end{aligned}
$$

**正規化:**

第1倍音（基音）の振幅を1.0に正規化：

| 倍音次数 $k$ | 周波数 $f_k$ | 振幅 $a_k$ |
|-------------|-------------|-----------|
| 1 | $f_0$ | 1.0 |
| 2 | $2f_0$ | 0.5 |
| 3 | $3f_0$ | 0.333... |
| ... | ... | ... |
| 10 | $10f_0$ | 0.1 |

#### 3.3.2 具体例（A4 = 440 Hz）

| 倍音次数 | 周波数 (Hz) | 振幅 | 音名（近似） |
|---------|------------|------|-------------|
| 1 | 440.0 | 1.000 | A4（基音） |
| 2 | 880.0 | 0.500 | A5（オクターブ） |
| 3 | 1320.0 | 0.333 | E6（完全5度上） |
| 4 | 1760.0 | 0.250 | A6（2オクターブ） |
| 5 | 2200.0 | 0.200 | C♯7（長3度上） |
| 10 | 4400.0 | 0.100 | A8（3オクターブ上の倍音） |

### 3.4 音色モデルの拡張性

実装では `TimbreModel` Protocol を定義し、将来的に異なる音色モデル（矩形波、三角波、楽器固有のスペクトラムなど）を容易に追加できる設計となっている。

---

## 4. クリティカルバンド幅理論

### 4.1 聴覚生理学的背景

**クリティカルバンド幅（Critical Bandwidth, CB）**は、聴覚系が周波数を分解できる最小単位を表す。2つの音が同じクリティカルバンド内に存在すると、神経レベルで干渉し、ラフネス（粗さ/ざらつき）として知覚される。

### 4.2 Bark尺度とクリティカルバンド

**Bark尺度**は、クリティカルバンドに基づく心理音響学的な周波数尺度である。人間の可聴域（20 Hz - 20 kHz）は約24 Barkに分割される。

Bark尺度への変換（Zwicker & Terhardt, 1980）：

$$
\text{Bark}(f) = 13 \arctan(0.00076f) + 3.5 \arctan\left(\left(\frac{f}{7500}\right)^2\right)
$$

クリティカルバンドの幅（Zwicker, 1961）：

$$
CB(f) = 25 + 75 \left[ 1 + 1.4 \left(\frac{f}{1000}\right)^2 \right]^{0.69}
$$

### 4.3 Plomp & Levelt の簡易近似

**Plomp & Levelt (1965)** の実験データに基づき、実用的な**線形近似式**が提案されている：

$$
CB(f) \approx 0.24 \times f + 25 \text{ Hz}
$$

#### 4.3.1 近似の妥当性検証

主要な周波数帯での比較：

| 周波数 (Hz) | 線形近似 (Hz) | Zwicker式 (Hz) | 誤差 (%) |
|------------|--------------|---------------|---------|
| 100 | 49.0 | 50.5 | -2.97 |
| 440 (A4) | 130.6 | 132.4 | -1.36 |
| 1000 | 265.0 | 267.8 | -1.05 |
| 5000 | 1225.0 | 1289.3 | -4.99 |

**結論:** 可聴域全体で十分な精度（誤差 < 5%）を持ち、計算コストが大幅に低い。

#### 4.3.2 実装における選択理由

1. **計算効率**: 線形式 vs. 超越関数（arctan, べき乗）
2. **精度**: 音楽応用において十分な精度
3. **シンプルさ**: コードの可読性と保守性

### 4.4 クリティカルバンドとラフネスの関係

2つの音の周波数差 $\Delta f$ とクリティカルバンド $CB(f)$ の関係：

- $\Delta f = 0$ （ユニゾン）: ラフネス = 0（協和）
- $\Delta f \approx 0.25 \times CB(f)$: ラフネスが最大（最大不協和）
- $\Delta f \gg CB(f)$: ラフネス → 0（協和）

この関係は次節のSetharesモデルで数式化される。

---

## 5. Setharesラフネスモデル

### 5.1 モデルの概要

**Sethares (1993)** は、Plomp & Levelt のラフネス曲線を数学的に定式化し、任意の倍音構造を持つ音色に対して協和度を計算可能にした。

本モデルの核心は、**すべての倍音ペア間のラフネスを計算し、総和する**という点にある。

### 5.2 ディソナンス曲線（Dissonance Curve）

#### 5.2.1 数学的定義

2つの純音（サインwave）間のディソナンス（不協和度）は、以下の**ディソナンス曲線** $g(x)$ でモデル化される：

$$
g(x) = e^{-b_1 x} - e^{-b_2 x}
$$

ここで：
- $x = \frac{\Delta f}{CB(f_{\min})}$: 正規化された周波数差
- $\Delta f = |f_2 - f_1|$: 2音間の周波数差 (Hz)
- $CB(f_{\min}) = CB(\min(f_1, f_2))$: 低い方の周波数のクリティカルバンド幅
- $b_1 = 3.5$: 曲線形状パラメータ1
- $b_2 = 5.75$: 曲線形状パラメータ2

#### 5.2.2 パラメータ $b_1$, $b_2$ の意味

- **$b_1$（小さい値）**: 緩やかな減衰を制御。周波数が離れるにつれてラフネスがゆっくり減少。
- **$b_2$（大きい値）**: 急峻な立ち上がりを制御。ユニゾン近傍でのラフネスの急増。

両パラメータは、Plomp & Levelt の実験データにフィッティングして決定された。

#### 5.2.3 ディソナンス曲線の形状

$g(x)$ の特性：

1. $x = 0$ （ユニゾン）: $g(0) = e^0 - e^0 = 0$
2. $x$ が小さい領域で急激に増加
3. $x \approx 0.24$ 付近でピーク（最大ディソナンス）
4. $x$ が大きくなると両指数項が0に収束し、$g(x) \to 0$

**グラフ的特徴:**

```
g(x)
  ↑
  │     ╱‾‾╲
  │    ╱    ╲___
  │___╱          ‾‾‾‾‾‾‾‾‾
  │
  └────────────────────────→ x
   0   0.1  0.24  0.5   1.0
```

ピーク位置の導出：

$$
\frac{dg}{dx} = -b_1 e^{-b_1 x} + b_2 e^{-b_2 x} = 0
$$

$$
\therefore x_{\text{peak}} = \frac{\ln(b_2/b_1)}{b_2 - b_1} = \frac{\ln(5.75/3.5)}{5.75 - 3.5} \approx 0.24
$$

これは実験的に観測される「クリティカルバンドの約1/4で最大ラフネス」と一致する。

### 5.3 ペアワイズラフネス（Pairwise Roughness）

#### 5.3.1 振幅重み付き計算

2つの倍音 $(f_1, a_1)$ と $(f_2, a_2)$ 間のラフネス $R$ は：

$$
R(f_1, f_2, a_1, a_2) = a_1 \times a_2 \times g\left( \frac{|f_2 - f_1|}{CB(\min(f_1, f_2))} \right)
$$

**物理的解釈:**
- 振幅積 $a_1 \times a_2$: ラフネスは両音の音量に比例
- ディソナンス曲線 $g(x)$: 周波数関係による不協和度

#### 5.3.2 重要な性質

1. **対称性**: $R(f_1, f_2, a_1, a_2) = R(f_2, f_1, a_2, a_1)$
2. **振幅依存性**: 片方の振幅が0なら $R = 0$
3. **周波数依存性**: クリティカルバンドは周波数依存なので、同じ音程でも低音域と高音域でラフネスが異なる

### 5.4 和音の総ラフネス（Total Roughness）

#### 5.4.1 計算手順

$N$ 個の音からなる和音を考える。各音は $M$ 個の倍音を持つとすると、総倍音数は $N \times M$ 個。

総ラフネス $R_{\text{total}}$ は、**すべての異なる倍音ペア**のラフネスの総和：

$$
R_{\text{total}} = \sum_{i=1}^{N \times M} \sum_{j=i+1}^{N \times M} R(f_i, f_j, a_i, a_j)
$$

ペア数は組み合わせ $\binom{N \times M}{2}$ で計算される：

$$
\text{ペア数} = \frac{(N \times M)(N \times M - 1)}{2}
$$

#### 5.4.2 計算量の考察

**例（3和音、10倍音）:**
- 総倍音数: $3 \times 10 = 30$
- ペア数: $\binom{30}{2} = 435$
- 各ペアで指数関数計算が必要

$O(N^2 M^2)$ の計算量となるが、現代のハードウェアでは十分高速（ミリ秒オーダー）。

### 5.5 実装における数値的安定性

#### 5.5.1 周波数差の正規化の重要性

**初期実装の誤り（修正済み）:**

```python
# ❌ 誤った実装
x = s * frequency_difference  # s = CB(f) ≈ 130 Hz, Δf ≈ 20 Hz
# → x ≈ 2600 → exp(-3.5 × 2600) ≈ 0 (アンダーフロー)
```

**正しい実装:**

```python
# ✅ 正しい実装
x = frequency_difference / critical_band  # x = Δf / CB
# → x ≈ 0.15 → exp(-3.5 × 0.15) ≈ 0.58 (正常な値)
```

正規化により、$x$ は次元を持たない適切な範囲（0〜数）に収まる。

#### 5.5.2 ゼロ除算の回避

$CB(f)$ は常に正（$f > 0$ で $CB > 25$）なので、ゼロ除算は発生しない。入力検証層で $f > 0$ を保証。

---

## 6. 数値例と検証

### 6.1 代表的な音程のラフネス計算

12-EDO、A4 (440 Hz) 基準、10倍音、Sawtooth timbreでの計算例。

#### 6.1.1 ユニゾン（単音）

**入力:** `[0]` (A4のみ)

**倍音列:**
- 10倍音 × 1音 = 10個の倍音
- ペア数: $\binom{10}{2} = 45$

**結果:** $R_{\text{total}} \approx 0.0118$

**解釈:** 同一音の倍音間でも干渉が発生。特に近接倍音（例: 2倍音440 Hzと3倍音1320 Hz）間のラフネス。

#### 6.1.2 完全5度（Perfect Fifth）

**入力:** `[0, 7]` (A4 - E5)

**周波数:**
- $f_1 = 440$ Hz
- $f_2 = 440 \times 2^{7/12} \approx 659.25$ Hz
- 周波数比: $\approx 3:2$

**倍音列:**
- 10倍音 × 2音 = 20個の倍音
- ペア数: $\binom{20}{2} = 190$

**結果:** $R_{\text{total}} \approx 0.0834$

**解釈:** 完全5度は純正音程（3:2）に近く、倍音が整合するため協和的。

#### 6.1.3 短2度（Minor Second）

**入力:** `[0, 1]` (A4 - A#4)

**周波数:**
- $f_1 = 440$ Hz
- $f_2 = 440 \times 2^{1/12} \approx 466.16$ Hz
- 周波数差: $\approx 26.16$ Hz

**倍音列:**
- 10倍音 × 2音 = 20個の倍音
- ペア数: 190

**結果:** $R_{\text{total}} \approx 0.3312$

**解釈:** 短2度は基音間の周波数差がクリティカルバンド内に収まり、強い干渉を引き起こす。完全5度の約4倍のラフネス。

#### 6.1.4 長3和音（Major Triad）

**入力:** `[0, 4, 7]` (A4 - C#5 - E5)

**周波数:**
- $f_1 = 440.0$ Hz
- $f_2 = 554.37$ Hz（長3度）
- $f_3 = 659.25$ Hz（完全5度）

**倍音列:**
- 10倍音 × 3音 = 30個の倍音
- ペア数: $\binom{30}{2} = 435$

**結果:** $R_{\text{total}} \approx 0.3703$

**解釈:** 3音が増えることでペア数が大幅に増加。短2度より高いラフネスを示すが、これは音数の増加によるもの。音響的には協和的な和音。

### 6.2 異なるEDOシステムの比較

#### 6.2.1 12-EDOの長3度

**ステップ:** 4 (400セント)
**周波数比:** $2^{4/12} = 2^{1/3} \approx 1.2599$
**純正長3度との差:** $400 - 386.31 = +13.69$ セント（鋭い）

#### 6.2.2 19-EDOの長3度

**ステップ:** 6 ($6 \times 63.16 \approx 378.95$ セント)
**周波数比:** $2^{6/19} \approx 1.2468$
**純正長3度との差:** $378.95 - 386.31 = -7.36$ セント（平坦）

19-EDOは12-EDOより純正長3度（5:4）に近い近似を提供し、異なる音響的性質を持つ。

### 6.3 倍音数の影響

同一和音で倍音数を変化させた比較：

| 倍音数 | ペア数（3和音） | 総ラフネス（近似） | 計算時間 |
|-------|----------------|------------------|---------|
| 5 | 105 | 0.125 | < 1 ms |
| 10 | 435 | 0.370 | < 1 ms |
| 20 | 1770 | 0.650 | 1-2 ms |

倍音数が増えると総ラフネスも増加するが、協和度の**相対的順位**は保たれる。デフォルト10倍音は計算コストと精度のバランスが良い。

---

## 7. 参考文献

### 7.1 主要文献

1. **Sethares, W. A. (1993).** "Local consonance and the relationship between timbre and scale." *Journal of the Acoustical Society of America*, 94(3), 1218-1228.
   - Setharesラフネスモデルの原論文
   - 音色と音律の相互作用の理論的基盤

2. **Plomp, R., & Levelt, W. J. M. (1965).** "Tonal consonance and critical bandwidth." *Journal of the Acoustical Society of America*, 38, 548-560.
   - クリティカルバンドと協和度の実験的研究
   - ラフネス曲線の実験的導出

3. **Zwicker, E., & Terhardt, E. (1980).** "Analytical expressions for critical-band rate and critical bandwidth as a function of frequency." *Journal of the Acoustical Society of America*, 68(5), 1523-1525.
   - Bark尺度の数学的定式化

### 7.2 補足資料

4. **Helmholtz, H. von (1863).** *On the Sensations of Tone*. Dover Publications (1954 reprint).
   - 倍音と協和度の古典的研究

5. **Partch, H. (1974).** *Genesis of a Music*. Da Capo Press.
   - Xenharmonicの哲学と実践

### 7.3 オンラインリソース

6. **Sethares, W. A.** *Tuning, Timbre, Spectrum, Scale*. Springer (2005).
   - 本モデルの詳細な解説書
   - オンライン補足資料: http://sethares.engr.wisc.edu/

7. **Xenharmonic Wiki**: https://en.xen.wiki/
   - N-EDO理論と実践のコミュニティリソース

---

**次のドキュメント:** [1004. アーキテクチャと実装詳細](./1004.architecture-implementation.md)

---

*このドキュメントは、Xenharmonic Voyager MVPの数学的基盤を記述しています。実装の詳細については関連ドキュメントを参照してください。*
